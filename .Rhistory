library(googlesheets4)
library(gargle)
library(scales)
library(lme4)
setwd("/Users/jannawilloughby/Documents/GDrive/loot/Bookclub/bookclub_ratings/")
####setup####
#requires tidyverse install and google sheets integration api, or public sheet
gs4_deauth()
data = read_sheet("https://docs.google.com/spreadsheets/d/1oBncOH7I_-keah3mvgpzcTlXhP95vR2SRa6gBlWSd2Y/edit?resourcekey#gid=216442974")
data = as.data.frame(data)
colnames(data) = c("date", "book", "rating", "reader")
meta = read_sheet("https://docs.google.com/spreadsheets/d/1icRZXs63DR6EpW29qzdWFn87jUF0HkJeY-ABaxIX9tQ/edit#gid=0")
meta = as.data.frame(meta)
colnames(meta) = c("book", "short", "reader", "month", "year")
books = unique(data$book)
readers = sort(unique(data$reader))
#remove duplicated ratings
newlist = NULL
for(i in 1:length(readers)){
temp    = data[data$reader==readers[i],,drop=F]
revbook = unique(temp$book)
for(tt in 1:length(revbook)){
x = temp[temp$book==as.character(revbook[tt]),,drop=F]
if(nrow(x)==1){
trow = x
}else{
trow = x[x$date==max(x$date),,drop=F]
}
newlist = rbind(newlist, trow)
}
}
data = as.data.frame(newlist)
#calculate median rating for each book
ratings = data.frame(books = books, short = rep(NA, length(books)), median = rep(NA, length(books)),mean = rep(NA, length(books)), min = rep(NA, length(books)), max = rep(NA, length(books)))
for(b in 1:length(books)){
temp = data[data$book==as.character(books[b]),,drop=F]
ratings$median[b] = median(temp$rating)
ratings$mean[b]   = mean(temp$rating)
ratings$min[b]    = min(temp$rating)
ratings$max[b]    = max(temp$rating)
ratings$short[b]  = meta$short[meta$book==books[b]]
}
ratings$seq=seq(1,nrow(ratings),1)
colors=c("darkorange1", "firebrick3", "chartreuse3", "dodgerblue3","darkorchid3")
jpeg("indvscores.jpg", width=480, height=480)
indvs = sort(unique(data$reader))
par(mar = c(5, 5, 1, 7), xpd=T)
plot(-100,-100, xlim=c(0.25,(length(indvs)+0.25)), ylim=c(0.75,10), xlab="", ylab="", axes=F)
axis(side=1, at=seq(1,length(indvs),1), labels=F, pos=0.75)
text(x = 1:length(indvs), y = par("usr")[3] - 0.5, labels = indvs, xpd = NA, cex = 1.2)
segments(x0=0, x1=0.25+length(indvs), y0=0.75, y1=0.75)
axis(side=2, at=seq(1,10,1), labels=T)
text(x=-0.7, y=5.5, labels = "ratings", xpd = NA, cex = 1.2, srt = 90)
p=1
for(b in 1:length(indvs)){
if(p==1){
polygon(x=c(b-.45, b+.45, b+.45, b-.45), y=c(0.95,0.95,10.1,10.1), col="grey95", border=NA)
p=0
next
}
if(p==0){
p=1
}
}
for(b in 1:length(indvs)){
temp = data[data$reader==as.character(indvs[b]),,drop=F]
if(nrow(temp)==0){next}
else{
points(jitter(rep(b, nrow(temp[!is.na(temp$rating),]) ), 4), temp$rating, pch=21, col=alpha(colors[b],1), bg=alpha(colors[b],0.5), cex=1.5)
}
segments(x0=(b-0.25), x1=(b+0.25), y0=median(temp$rating), y1=median(temp$rating), lwd=1.5)
}
dev.off()
